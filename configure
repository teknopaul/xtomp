#!/bin/bash -e

cd $(dirname $0)

. version



args='--with-xtomp --without-http'
opts='--prefix=/usr/local/xtomp
        --sbin-path=/usr/local/xtomp/bin/xtomp
        --modules-path=/usr/local/xtomp/modules
        --conf-path=/etc/xtomp.conf
        --error-log-path=/var/log/xtomp/error.log
        --pid-path=/var/run/xtomp/xtomp.pid
        --lock-path=/var/run/xtomp
        --user=xtomp
        --group=xtomp'

snapopts='--prefix=/usr/local/xtomp
        --sbin-path=/usr/local/xtomp/bin/xtomp
        --modules-path=/usr/local/xtomp/modules
        --conf-path=/etc/xtomp.conf
        --error-log-path=/var/snap/xtomp/error.log
        --pid-path=/var/snap/xtomp/xtomp.pid
        --lock-path=/var/snap/xtomp
        --user=xtomp
        --group=xtomp'

deploy/fix-version.sh

if [ $(hostname) == ci ] || [ "$1" == "prod" ]
then
  auto/configure $args $opts --with-cc-opt='-O3'
elif [ "$1" == "snap" ]
then
  auto/configure $args $snapopts --with-cc-opt='-O3'
else
  auto/configure $args --with-debug --with-cc-opt='-O0 -g' $opts
fi
